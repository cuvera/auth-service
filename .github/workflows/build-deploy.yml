name: Dev Build and Deploy

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

env:
  NODE_VERSION: '22.18.0'

jobs:
  build:
    runs-on: self-hosted
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create npmrc files
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
          VARS_CONTEXT: ${{ toJson(vars) }}
        run: |          
          # Create .npmrc for Azure DevOps authentication
          if [ -n "${{ secrets.NPMRC_CONTENT }}" ]; then
            echo "${{ secrets.NPMRC_CONTENT }}" | sed 's/\\n/\n/g' > .npmrc
          else
            cat > .npmrc << EOF
          @cuvera:registry=https://pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:username=ashwinialike
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:_password=${{ secrets.AZURE_DEVOPS_TOKEN }}
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:email=info@cuvera.ai
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:always-auth=true
          registry=https://registry.npmjs.org/
          EOF
          fi

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY_URL }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY_URL }}/auth-service:latest
            ${{ secrets.DOCKER_REGISTRY_URL }}/auth-service:latest

  deploy:
    needs: build
    runs-on: self-hosted
    environment: dev
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      - name: Parse deployment variables
        id: deploy_vars
        run: |
          # Extract individual variables
          echo "VM_HOST=${{ vars.VM_HOST }}" >> $GITHUB_OUTPUT
          echo "VM_USER=${{ vars.VM_USER }}" >> $GITHUB_OUTPUT
          
          # Extract SERVICE_NAME from DEV_ENV
          SERVICE_NAME=$(echo "${{ vars.DEV_ENV }}" | sed 's/\\r\\n/\n/g' | grep "^SERVICE_NAME=" | cut -d'=' -f2 | tr -d '\r\n' | xargs)
          echo "SERVICE_NAME=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ steps.deploy_vars.outputs.VM_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to dev server
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
          VARS_CONTEXT: ${{ toJson(vars) }}
        run: |
          # Create .env file with Docker Compose variables first
          cat > .env << EOF
          # Docker Compose Configuration
          DOCKER_REGISTRY_URL=${{ secrets.DOCKER_REGISTRY_URL }}
          IMAGE_TAG=${{ github.sha }}
          SERVICE_NAME=${{ steps.deploy_vars.outputs.SERVICE_NAME }}
          
          # Application Environment
          NODE_ENV=development
          EOF
          
          # Add all secrets (excluding Docker/GitHub specific ones)
          echo "$SECRETS_CONTEXT" | jq -r 'to_entries[] | select(.key != "SSH_PRIVATE_KEY" and .key != "GITHUB_TOKEN" and .key != "NPMRC_CONTENT" and .key != "AZURE_DEVOPS_TOKEN" and .key != "DOCKER_REGISTRY_URL" and .key != "DOCKER_REGISTRY_USERNAME" and .key != "DOCKER_REGISTRY_PASSWORD") | "\(.key)=\(.value)"' >> .env
          
          # Process DEV_ENV variable (handle \r\n properly)
          echo "$VARS_CONTEXT" | jq -r '.DEV_ENV // ""' | sed 's/\\r\\n/\n/g' | grep -v '^#' | grep -v '^$' | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ]; then
              echo "${key}=${value}" >> .env
            fi
          done
          
          # Add other variables except DEV_ENV
          echo "$VARS_CONTEXT" | jq -r 'to_entries[] | select(.key != "DEV_ENV") | "\(.key)=\(.value)"' >> .env

          VM_USER="${{ steps.deploy_vars.outputs.VM_USER }}"
          VM_HOST="${{ steps.deploy_vars.outputs.VM_HOST }}"
          SERVICE_NAME="${{ steps.deploy_vars.outputs.SERVICE_NAME }}"

          # Clean variables to remove carriage returns and whitespace
          VM_USER=$(echo "$VM_USER" | tr -d '\r\n' | xargs)
          VM_HOST=$(echo "$VM_HOST" | tr -d '\r\n' | xargs)
          SERVICE_NAME=$(echo "$SERVICE_NAME" | tr -d '\r\n' | xargs)

          # Create deployment directory
          ssh "${VM_USER}@${VM_HOST}" "mkdir -p '/home/cuvera/${SERVICE_NAME}' && echo 'Directory created: /home/cuvera/${SERVICE_NAME}' && ls -la /home/cuvera/"
          
          # Upload docker-compose.yml and .env
          scp docker-compose.yml .env "${VM_USER}@${VM_HOST}:/home/cuvera/${SERVICE_NAME}/"
          
          # Deploy with docker-compose
          ssh "${VM_USER}@${VM_HOST}" << ENDSSH
          cd "/home/cuvera/${SERVICE_NAME}"
          
          # Verify we're in the right directory and files exist
          echo "Current directory: \$(pwd)"
          echo "Files in directory:"
          ls -la
          
          # Docker registry login
          echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY_URL }} -u ${{ secrets.DOCKER_REGISTRY_USERNAME }} --password-stdin
          
          # Deploy with docker-compose
          docker-compose pull
          docker-compose down
          docker-compose up -d
          
          # Show status
          docker-compose ps
          docker-compose logs --tail=20
          ENDSSH
          
      - name: Health check
        run: |
          sleep 15
          VM_HOST="${{ steps.deploy_vars.outputs.VM_HOST }}"
          SERVICE_NAME="${{ steps.deploy_vars.outputs.SERVICE_NAME }}"
          
          # Clean variables to remove carriage returns and whitespace
          VM_HOST=$(echo "$VM_HOST" | tr -d '\r\n' | xargs)
          SERVICE_NAME=$(echo "$SERVICE_NAME" | tr -d '\r\n' | xargs)
          
          HEALTH_URL="https://${VM_HOST}/${SERVICE_NAME}/health"
          echo "Health check URL: $HEALTH_URL"
          curl -f "$HEALTH_URL" || exit 1