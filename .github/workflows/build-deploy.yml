name: Dev Build and Deploy

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

env:
  NODE_VERSION: '22.18.0'

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Create npmrc files
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
          VARS_CONTEXT: ${{ toJson(vars) }}
        run: |          
          # Create .npmrc for Azure DevOps authentication
          if [ -n "${{ secrets.NPMRC_CONTENT }}" ]; then
            echo "${{ secrets.NPMRC_CONTENT }}" | sed 's/\\n/\n/g' > .npmrc
          else
            cat > .npmrc << EOF
          @cuvera:registry=https://pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:username=ashwinialike
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:_password=${{ secrets.AZURE_DEVOPS_TOKEN }}
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:email=info@cuvera.ai
          //pkgs.dev.azure.com/ashwinialike/_packaging/ashwinialike/npm/registry/:always-auth=true
          registry=https://registry.npmjs.org/
          EOF
          fi
          
      - name: Install dependencies
        run: |
          npm cache clean --force
          npm install --audit=false
          
      - name: Build application
        run: npm run build
        
      - name: Prepare artifacts
        run: |
          echo "Files in current directory:"
          ls -la
          echo "Contents of .npmrc:"
          cat .npmrc || echo ".npmrc not found"
          
          # Rename dotfiles to avoid upload issues
          cp .npmrc npmrc-file
          
          echo "Files after renaming:"
          ls -la npmrc-file
          
      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-build-${{ github.sha }}
          path: |
            dist/
            package.json
            package-lock.json
            npmrc-file
          retention-days: 3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dev-build-${{ github.sha }}
          
      - name: Restore and verify files
        run: |
          echo "Files after download:"
          ls -la
          
          # Rename files back to dotfiles
          mv npmrc-file .npmrc
          
          echo "Files after restoring names:"
          ls -la
          echo "Checking .npmrc file:"
          cat .npmrc
          
      - name: Parse deployment variables
        id: deploy_vars
        run: |
          # Use individual variables instead of parsing DEV_ENV
          echo "VM_HOST=${{ vars.VM_HOST }}" >> $GITHUB_OUTPUT
          echo "VM_USER=${{ vars.VM_USER }}" >> $GITHUB_OUTPUT

          # Extract deployment variables from DEV_ENV
          echo "${{ vars.DEV_ENV }}" | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ]; then
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done
          
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ steps.deploy_vars.outputs.VM_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to dev server
        run: |
          # Create .env file from all secrets and vars automatically
          echo "NODE_ENV=development" > .env
          
          # Dump all secrets to .env (excluding sensitive keys)
          echo "$SECRETS_CONTEXT" | jq -r 'to_entries[] | select(.key != "SSH_PRIVATE_KEY" and .key != "GITHUB_TOKEN") | "\(.key)=\(.value)"' >> .env
          
          # Dump all variables to .env
          echo "$VARS_CONTEXT" | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> .env

          VM_USER="${{ steps.deploy_vars.outputs.VM_USER }}"
          VM_HOST="${{ steps.deploy_vars.outputs.VM_HOST }}"
          SERVICE_NAME="${{ steps.deploy_vars.outputs.SERVICE_NAME }}"

          # Clean variables to remove carriage returns and whitespace
          VM_USER=$(echo "$VM_USER" | tr -d '\r\n' | xargs)
          VM_HOST=$(echo "$VM_HOST" | tr -d '\r\n' | xargs)
          SERVICE_NAME=$(echo "$SERVICE_NAME" | tr -d '\r\n' | xargs)
          
          echo "Raw SERVICE_NAME: '${SERVICE_NAME}'"
          echo "SERVICE_NAME in hex: $(echo -n "$SERVICE_NAME" | xxd)"
          echo "Target directory: '/home/cuvera/${SERVICE_NAME}'"

          # Create deployment directory
          ssh "${VM_USER}@${VM_HOST}" "mkdir -p '/home/cuvera/${SERVICE_NAME}' && echo 'Directory created: /home/cuvera/${SERVICE_NAME}' && ls -la /home/cuvera/"
          
          # Upload files
          scp -r dist/ package*.json .env .npmrc "${VM_USER}@${VM_HOST}:/home/cuvera/${SERVICE_NAME}/"
          
          # Deploy and restart service
          ssh "${VM_USER}@${VM_HOST}" << ENDSSH
          cd "/home/cuvera/${SERVICE_NAME}"
          
          # Verify we're in the right directory and files exist
          echo "Current directory: \$(pwd)"
          echo "Files in directory:"
          ls -la
          
          # Install production dependencies
          npm cache clean --force
          npm install --only=production --audit=false
          
          # Check PM2 status before stopping
          pm2 list
          
          # Restart service with PM2
          pm2 stop "${SERVICE_NAME}" || true
          pm2 delete "${SERVICE_NAME}" || true
          pm2 start dist/app.js --name "${SERVICE_NAME}" --update-env
          pm2 save
          ENDSSH
          
      - name: Health check
        run: |
          sleep 15
          VM_HOST="${{ steps.deploy_vars.outputs.VM_HOST }}"
          SERVICE_NAME="${{ steps.deploy_vars.outputs.SERVICE_NAME }}"
          
          # Clean variables to remove carriage returns and whitespace
          VM_HOST=$(echo "$VM_HOST" | tr -d '\r\n' | xargs)
          SERVICE_NAME=$(echo "$SERVICE_NAME" | tr -d '\r\n' | xargs)
          
          HEALTH_URL="https://${VM_HOST}/${SERVICE_NAME}/health"
          echo "Health check URL: $HEALTH_URL"
          curl -f "$HEALTH_URL" || exit 1